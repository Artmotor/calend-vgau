<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Личный кабинет сотрудника Института ДПО</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            -webkit-text-size-adjust: 100%;
        }
        
        .header-container {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        
        .logo-text h1 {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }
        
        .logo-text p {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .burger-menu-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-left: 1rem;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: calc(100vh - 150px);
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
        }
        
        /* Стили для вкладок */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            background-color: #f1f1f1;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background-color: #ddd;
        }
        
        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 1rem;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Стили для таблицы мероприятий */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .events-table th, .events-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .events-table th {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .events-table th:hover {
            background-color: var(--dark-color);
        }
        
        .events-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            white-space: nowrap;
        }
        
        .status-active {
            background-color: var(--success-color);
        }
        
        .status-upcoming {
            background-color: var(--warning-color);
        }
        
        .status-completed {
            background-color: var(--danger-color);
        }
        
        .registration-button {
            padding: 0.5rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            white-space: nowrap;
            font-size: 0.8rem;
        }
        
        .registration-button.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .registration-button.completed {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .registration-button.unavailable {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
        }
        
        .registration-button.closed {
            background-color: #f8d7da;
            color: #721c24;
            cursor: not-allowed;
        }
        
        /* Стили для фильтров */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
            flex-grow: 1;
        }
        
        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .filter-group select, .filter-group input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            -webkit-appearance: none;
            appearance: none;
            background-color: white;
            font-size: 0.9rem;
        }
        
        /* Стили для модального окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background-color: white;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 5px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--dark-color);
        }
        
        /* Стили для форм авторизации */
        .auth-container {
            max-width: 500px;
            margin: 2rem auto;
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auth-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        .auth-button:hover {
            background-color: var(--dark-color);
        }
        
        .hidden {
            display: none !important;
        }
        
        .error-message {
            color: var(--danger-color);
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #f8d7da;
            border-radius: 4px;
            text-align: center;
        }
        
        .success-message {
            color: var(--success-color);
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #d4edda;
            border-radius: 4px;
            text-align: center;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .summary-row td {
            padding: 10px;
            border-top: 2px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
        }
        
        /* Мобильные стили */
        @media (max-width: 768px) {
            .header-container {
                padding: 0.75rem;
            }
            
            .logo img {
                height: 35px;
            }
            
            .logo-text h1 {
                font-size: 1rem;
            }
            
            .logo-text p {
                font-size: 0.75rem;
            }
            
            .burger-menu-button {
                padding: 0.25rem;
                font-size: 1.3rem;
            }
            
            .main-container {
                padding: 0.75rem;
            }
            
            .tabs {
                flex-direction: column;
                border-bottom: none;
                display: none;
            }
            
            .tabs.mobile-visible {
                display: flex;
            }
            
            .tab {
                border-radius: 0;
                border: 1px solid #ddd;
                border-bottom: none;
                margin-right: 0;
                padding: 0.5rem 1rem;
            }
            
            .tab:last-child {
                border-bottom: 1px solid #ddd;
            }
            
            .tab-content {
                padding: 0.75rem;
            }
            
            .filters {
                padding: 0.75rem;
                gap: 0.5rem;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .filter-group select, .filter-group input {
                padding: 0.5rem;
            }
            
            .auth-container {
                margin: 1rem;
                padding: 1.2rem;
            }
            
            .modal-content {
                padding: 1.2rem;
                margin: 1rem auto;
            }
            
            .events-table th, .events-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.85rem;
            }
            
            .status-badge, .registration-button {
                font-size: 0.75rem;
                padding: 0.2rem 0.4rem;
            }
        }
        
        @media (max-width: 480px) {
            .logo img {
                height: 30px;
            }
            
            .logo-text h1 {
                font-size: 0.9rem;
            }
            
            .logo-text p {
                font-size: 0.7rem;
            }
            
            .auth-container {
                padding: 1rem;
            }
            
            .form-group input {
                padding: 0.6rem;
            }
            
            .auth-button {
                padding: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <header class="header-container">
        <div class="logo">
            <img src="https://artmotor.github.io/calend-vgau/img/logo.png" alt="Логотип">
            <div class="logo-text">
                <h1>Институт дополнительного образования</h1>
                <p>Личный кабинет сотрудника</p>
            </div>
        </div>
        <button class="burger-menu-button" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <div id="auth-section" class="auth-container">
        <div id="login-form">
            <h2>Авторизация сотрудника</h2>
            <div class="form-group">
                <label>Фамилия:</label>
                <input type="text" id="surname" required>
            </div>
            <div class="form-group">
                <label>Пароль:</label>
                <input type="password" id="password" required>
            </div>
            <button id="login-btn" class="auth-button">Войти</button>
            <div id="message" class="hidden"></div>
            <div id="loader" class="loader hidden"></div>
        </div>
    </div>

    <div id="lk-section" class="main-container hidden">
        <div class="tabs" id="main-tabs">
            <div class="tab active" data-tab="events">Реестр мероприятий</div>
            <div class="tab" data-tab="documents">Печать документов</div>
            <div class="tab" data-tab="statistics">Статистика</div>
            <div class="tab" data-tab="logout" style="margin-left: auto;">Выйти</div>
        </div>

        <div id="events-tab" class="tab-content active">
            <div class="filters">
                <div class="filter-group">
                    <label for="year-filter">Год:</label>
                    <select id="year-filter">
                        <option value="all">Все года</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="event-type">Вид мероприятия:</label>
                    <select id="event-type">
                        <option value="all">Все виды</option>
                        <option value="Й">Мастер-класс</option>
                        <option value="X">Курсы повышения квалификации</option>
                        <option value="Z">Переподготовка</option>
                        <option value="М">Мероприятие</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="event-status">Статус:</label>
                    <select id="event-status">
                        <option value="all">Все статусы</option>
                        <option value="active">Идет сейчас</option>
                        <option value="upcoming">Не началось</option>
                        <option value="completed">Завершено</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="has-link">Ссылка:</label>
                    <select id="has-link">
                        <option value="all">Все</option>
                        <option value="yes">С ссылкой</option>
                        <option value="no">Без ссылки</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search">Поиск:</label>
                    <input type="text" id="search" placeholder="Поиск по названию...">
                </div>
                <button id="apply-filters" class="auth-button">Применить</button>
                <button id="reset-filters" class="auth-button">Сбросить</button>
            </div>
            
            <div class="table-container">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th data-sort="id">ID <i class="fas fa-sort"></i></th>
                            <th data-sort="year">Год <i class="fas fa-sort"></i></th>
                            <th data-sort="name">Название <i class="fas fa-sort"></i></th>
                            <th data-sort="date">Дата <i class="fas fa-sort"></i></th>
                            <th data-sort="type">Вид <i class="fas fa-sort"></i></th>
                            <th>Статус</th>
                            <th>Действие</th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="documents-tab" class="tab-content">
            <h2>Печать документов</h2>
            <a href="https://zt.titul24.ru/form?userID=1193293328&label=%D0%92%D0%93%D0%90%D0%A3%20%D0%94%D0%9F%D0%9E%20--%20%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%20%D0%94%D0%9F%D0%9E" class="btn btn-primary btn-sm" role="button" aria-pressed="true">Сертификат</a>
	    <a href="https://zt.titul24.ru/form?userID=1193293328&label=%D0%92%D0%93%D0%90%D0%A3%20%D0%94%D0%9F%D0%9E%20--%20%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%20%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D0%B0%D0%BB%D0%B8%D1%81%D1%82%D0%B0" class="btn btn-success btn-sm" role="button" aria-pressed="true">Сертификат специалиста</a>
        </div>

        <div id="statistics-tab" class="tab-content">
            <h2>Статистика</h2>
            <p>Раздел находится в разработке. Здесь будут отображаться статистические данные по мероприятиям и участникам.</p>
        </div>
    </div>

    <footer class="footer">
        <p>© 2025 Институт дополнительного профессионального образования ВГАУ. Все права защищены.</p>
        <p>Контактная информация: info@institute.edu | +7 (XXX) XXX-XX-XX</p>
    </footer>

    <!-- Модальное окно для деталей мероприятия -->
    <div id="event-details-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-event-title"></h2>
            <div id="modal-event-content"></div>
        </div>
    </div>

    <script>
// Объект приложения
const APP = {
    users: [],
    events: [],
    proxyUrls: [
        ''
    ],
    usersSheetUrl: 'https://vgau.edu37.ru/api/users?gid=0&single=true&output=csv',
    eventsSheetUrl: 'https://vgau.edu37.ru/api/calendar?gid=18228916&single=true&output=csv',
    currentUser: null,
    currentSort: { field: 'date', direction: 'asc' },
    currentProxyIndex: 0,
    
    init: function() {
        this.setupListeners();
        
        // Проверяем авторизацию при загрузке
        const storedUser = this.getStoredUser();
        if (storedUser) {
            this.currentUser = storedUser;
            this.showLkSection();
            this.loadEvents().then(() => {
                this.renderEvents();
            }).catch(error => {
                this.showMessage(`Ошибка загрузки мероприятий: ${error.message}`, 'error');
            });
        } else {
            this.showAuthSection();
        }
        
        this.addYearOptions();
    },

    addYearOptions: function() {
     const yearFilter = document.getElementById('year-filter');
    if (!yearFilter) return;
    
    // Очищаем существующие опции, кроме первой ("Все года")
    while (yearFilter.options.length > 1) {
        yearFilter.remove(1);
    }
    
    const currentYear = new Date().getFullYear();
    
    // Добавляем текущий год первым
    const currentOption = document.createElement('option');
    currentOption.value = currentYear;
    currentOption.textContent = currentYear + ' (текущий)'; // Можно убрать "(текущий)" если не нужно
    yearFilter.appendChild(currentOption);
    
    // Добавляем 1 предыдущих года в обратном порядке (от самого нового к самому старому)
    for (let i = 1; i <= 1; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    }
    
    // Добавляем 1 следующий год
    const nextYear = currentYear + 1;
    const nextOption = document.createElement('option');
    nextOption.value = nextYear;
    nextOption.textContent = nextYear;
    yearFilter.appendChild(nextOption);
},

    toggleLoader: function(show) {
        document.getElementById('loader').classList.toggle('hidden', !show);
    },
    
    loadUsers: async function() {
        try {
            const response = await fetch(`${this.proxyUrls[0]}${(this.usersSheetUrl)}`);
            
            if (!response.ok) {
                throw new Error(`Ошибка HTTP: ${response.status}`);
            }
            
            const csvData = await response.text();
            this.parseCSV(csvData);
        } catch (error) {
            console.error('Ошибка загрузки пользователей:', error);
            throw new Error(`Не удалось загрузить данные пользователей: ${error.message}`);
        }
    },
    
    loadEvents: function() {
        return new Promise((resolve, reject) => {
            const sheetUrl = encodeURIComponent(this.eventsSheetUrl);
            
            const tryFetchWithProxy = () => {
                if (this.currentProxyIndex >= this.proxyUrls.length) {
                    console.error('All proxies failed, using test data');
                    this.useTestData();
                    resolve();
                    return;
                }

                const proxyUrl = this.proxyUrls[this.currentProxyIndex];
                fetch(proxyUrl + sheetUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.text();
                    })
                    .then(data => {
                        this.events = this.parseEventsCSV(data);
                        window.eventsData = this.events;
                        resolve();
                    })
                    .catch(error => {
                        console.error(`Proxy ${proxyUrl} failed:`, error);
                        this.currentProxyIndex++;
                        tryFetchWithProxy();
                    });
            };

            tryFetchWithProxy();
        });
    },
    
    useTestData: function() {
        this.events = [
            {
                'ID курса': 'Z-2023-123',
                'Название': 'Курс повышения квалификации по педагогике',
                'Описание': '72-часовой курс для преподавателей',
                'Дата': '15.09.2023',
                'Ссылка': 'https://example.com/course1'
            },
            {
                'ID курса': 'Й-2023-456',
                'Название': 'Мастер-класс по цифровым технологиям',
                'Описание': 'Однодневный интенсив по современным технологиям',
                'Дата': '20.08.2023',
                'Ссылка': ''
            },
            {
                'ID курса': 'X-2024-789',
                'Название': 'Профессиональная переподготовка "Менеджмент"',
                'Описание': '250-часовой курс для руководителей',
                'Дата': '01.10.2024',
                'Ссылка': 'https://example.com/course3'
            }
        ];
        window.eventsData = this.events;
    },
    
    parseCSV: function(csvData) {
        const rows = csvData.split('\n').slice(1);
        
        this.users = rows
            .map(row => {
                const [surname, password, role] = row.split(',').map(cell => cell.trim());
                return surname && password && role ? { surname, password, role } : null;
            })
            .filter(user => user !== null);
    },
    
    parseEventsCSV: function(csvData) {
        const rows = csvData.split('\n');
        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        return rows.slice(1).map(row => {
            // Обрабатываем строку с учетом возможных запятых в значениях
            const values = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue.trim());
            
            const event = {};
            
            headers.forEach((header, i) => {
                // Приводим все возможные варианты названий к единому формату
                const normalizedHeader = header
                    .replace(/"/g, '')
                    .trim()
                    .toLowerCase()
                    .replace(/[^a-zа-яё0-9]/gi, '');
                
                // Определяем, является ли текущий заголовок ID курса
                if (normalizedHeader.includes('id') && 
                    (normalizedHeader.includes('курс') || normalizedHeader.includes('course'))) {
                    event['ID курса'] = values[i] ? values[i].replace(/"/g, '').trim() : '';
                } else {
                    event[header] = values[i] ? values[i].replace(/"/g, '').trim() : '';
                }
            });
            
            // Если ID курса не найден в заголовках, попробуем найти его в данных
            if (!event['ID курса']) {
                for (const key in event) {
                    if (key.toLowerCase().includes('id') && 
                        (key.toLowerCase().includes('курс') || key.toLowerCase().includes('course'))) {
                        event['ID курса'] = event[key];
                        break;
                    }
                }
            }
            
            // Если ID курса все еще не найден, используем первое поле, содержащее "id"
            if (!event['ID курса']) {
                for (const key in event) {
                    if (key.toLowerCase().includes('id')) {
                        event['ID курса'] = event[key];
                        break;
                    }
                }
            }
            
            return event;
        }).filter(event => event['ID курса']); // Фильтруем пустые строки
    },
    
    renderEvents: function() {
        const tableBody = document.getElementById('events-table-body');
        tableBody.innerHTML = '';
        
        if (!this.events || this.events.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 7;
            cell.textContent = 'Нет данных о мероприятиях';
            cell.style.textAlign = 'center';
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        
        // Группируем мероприятия по ID курса
        const eventsByCourse = this.groupEventsByCourseId(this.events);
        
        // Сортируем мероприятия
        const sortedCourses = this.sortGroupedEvents(eventsByCourse);
        
        // Получаем выбранный год из селектора
        const yearFilter = document.getElementById('year-filter');
        const selectedYear = yearFilter ? yearFilter.value : 'all';
        
        // Фильтруем по году, если нужно
        const filteredCourses = selectedYear === 'all' 
            ? sortedCourses 
            : sortedCourses.filter(course => {
                const id = course[0]['ID курса'] || '';
                const eventYear = this.extractYearFromId(id);
                return eventYear === parseInt(selectedYear);
            });
        
        // Счетчики мероприятий
        const totalCount = sortedCourses.length;
        const filteredCount = filteredCourses.length;
        
        // Добавляем строку с итогами
        const summaryRow = document.createElement('tr');
        summaryRow.className = 'summary-row';
        
        const summaryCell = document.createElement('td');
        summaryCell.colSpan = 7;
        summaryCell.style.fontWeight = 'bold';
        summaryCell.style.textAlign = 'center';
        
        let summaryText = `Всего мероприятий: ${totalCount}`;
        if (selectedYear !== 'all') {
            summaryText += ` | Отфильтровано: ${filteredCount}`;
        }
        
        summaryCell.textContent = summaryText;
        summaryRow.appendChild(summaryCell);
        tableBody.appendChild(summaryRow);
        
        // Заполняем таблицу
        filteredCourses.forEach(courseEvents => {
            const row = document.createElement('tr');
            row.addEventListener('click', () => this.showEventDetails(courseEvents));
            row.style.cursor = 'pointer';
            
            // ID курса
            const idCell = document.createElement('td');
            idCell.textContent = courseEvents[0]['ID курса'] || '—';
            row.appendChild(idCell);
            
            // Год
            const yearCell = document.createElement('td');
            const id = courseEvents[0]['ID курса'] || '';
            const eventYear = this.extractYearFromId(id) || '—';
            yearCell.textContent = eventYear;
            row.appendChild(yearCell);
            
            // Название
            const nameCell = document.createElement('td');
            nameCell.textContent = courseEvents[0]['Название'] || 'Мероприятие';
            row.appendChild(nameCell);
            
            // Дата
            const dateCell = document.createElement('td');
            const uniqueDates = [...new Set(courseEvents.map(e => e.Дата))];
            dateCell.textContent = uniqueDates.join(', ');
            row.appendChild(dateCell);
            
            // Вид мероприятия
            const typeCell = document.createElement('td');
            const eventType = this.getEventType(courseEvents[0]['ID курса']);
            typeCell.textContent = eventType;
            row.appendChild(typeCell);
            
            // Статус
            const statusCell = document.createElement('td');
            const status = this.getCourseStatus(courseEvents);
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge status-${status.class}`;
            statusBadge.textContent = status.text;
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            // Кнопка записи
            const actionCell = document.createElement('td');
            const registrationButton = this.createRegistrationButton(courseEvents);
            actionCell.appendChild(registrationButton);
            row.appendChild(actionCell);
            
            tableBody.appendChild(row);
        });
    },
    
    setupListeners: function() {
        // Авторизация
        document.getElementById('login-btn').addEventListener('click', () => this.checkAuth());
        
        document.getElementById('surname').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.checkAuth();
        });
        
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.checkAuth();
        });
        
        // Вкладки
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                if (tabId === 'logout') {
                    this.logout();
                    return;
                }
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Скрываем меню на мобильных устройствах после выбора вкладки
                if (window.innerWidth <= 768) {
                    document.getElementById('main-tabs').classList.remove('mobile-visible');
                }
            });
        });
        
        // Сортировка таблицы
        document.querySelectorAll('.events-table th[data-sort]').forEach(header => {
            header.addEventListener('click', () => {
                const field = header.getAttribute('data-sort');
                this.sortEvents(field);
            });
        });
        
        // Фильтры
        document.getElementById('apply-filters').addEventListener('click', () => this.applyFilters());
        document.getElementById('reset-filters').addEventListener('click', () => this.resetFilters());
        
        // Модальное окно
        document.querySelector('.modal .close').addEventListener('click', () => {
            document.getElementById('event-details-modal').style.display = 'none';
        });
        
        // Закрытие модального окна при клике вне его
        document.addEventListener('click', (e) => {
            if (e.target === document.getElementById('event-details-modal')) {
                document.getElementById('event-details-modal').style.display = 'none';
            }
        });
        
        // Добавляем слушатель для селектора года
        const yearFilter = document.getElementById('year-filter');
        if (yearFilter) {
            yearFilter.addEventListener('change', () => this.renderEvents());
        }
    },

    extractYearFromId: function(id) {
        if (!id) return null;
        
        // Ищем год в формате X-YYYY-N или X-YY-N
        const match = id.match(/-(\d{2,4})-/);
        if (match) {
            let year = parseInt(match[1]);
            // Если год указан двумя цифрами, преобразуем в четырехзначный
            if (year < 100) {
                year = year < 50 ? 2000 + year : 1900 + year;
            }
            return year;
        }
        
        // Если год не найден в ID, попробуем извлечь из даты
        return null;
    },
    
    checkAuth: async function() {
        const surname = document.getElementById('surname').value.trim();
        const password = document.getElementById('password').value.trim();
        
        if (!surname || !password) {
            this.showMessage('Заполните все поля', 'error');
            return;
        }
        
        try {
            this.toggleLoader(true);
            
            // Загружаем пользователей перед проверкой
            await this.loadUsers();
            
            const user = this.users.find(u => 
                u.surname.toLowerCase() === surname.toLowerCase() && 
                u.password === password
            );
            
            if (user) {
                this.currentUser = user;
                this.storeUser(user);
                this.handleSuccessAuth();
            } else {
                this.showMessage('Неверные учетные данные', 'error');
            }
        } catch (error) {
            this.showMessage(`Ошибка авторизации: ${error.message}`, 'error');
        } finally {
            this.toggleLoader(false);
        }
    },
    
    handleSuccessAuth: function() {
        this.showMessage('Успешная авторизация!', 'success');
        
        setTimeout(() => {
            this.showLkSection();
            
            // Загружаем мероприятия после авторизации
            this.loadEvents().then(() => {
                this.renderEvents();
            }).catch(error => {
                this.showMessage(`Ошибка загрузки мероприятий: ${error.message}`, 'error');
            });
        }, 1000);
    },
    
    showAuthSection: function() {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('lk-section').classList.add('hidden');
        document.getElementById('surname').focus();
    },
    
    showLkSection: function() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('lk-section').classList.remove('hidden');
    },
    
    logout: function() {
        this.currentUser = null;
        this.clearStoredUser();
        this.showAuthSection();
        document.getElementById('surname').value = '';
        document.getElementById('password').value = '';
        document.getElementById('message').classList.add('hidden');
    },
    
    showMessage: function(text, type = 'info') {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = type === 'error' ? 'error-message' : 'success-message';
        msg.classList.remove('hidden');
        
        if (type !== 'error') {
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }
    },
    
    storeUser: function(user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
    },
    
    getStoredUser: function() {
        const user = localStorage.getItem('currentUser');
        return user ? JSON.parse(user) : null;
    },
    
    clearStoredUser: function() {
        localStorage.removeItem('currentUser');
    },
    
    groupEventsByCourseId: function(events) {
        const grouped = {};
        
        events.forEach(event => {
            const courseId = event['ID курса'] || 'no-id';
            if (!grouped[courseId]) {
                grouped[courseId] = [];
            }
            grouped[courseId].push(event);
        });
        
        return grouped;
    },
    
    sortGroupedEvents: function(groupedEvents) {
        const sortField = this.currentSort.field;
        const sortDirection = this.currentSort.direction;
        
        return Object.values(groupedEvents).sort((a, b) => {
            let compareA, compareB;
            
            switch (sortField) {
                case 'id':
                    compareA = a[0]['ID курса'] || '';
                    compareB = b[0]['ID курса'] || '';
                    return this.naturalSort(compareA, compareB, sortDirection);
                case 'name':
                    compareA = a[0]['Название'] || '';
                    compareB = b[0]['Название'] || '';
                    break;
                case 'date':
                    compareA = this.parseDate(a[0]['Дата']) || 0;
                    compareB = this.parseDate(b[0]['Дата']) || 0;
                    break;
                case 'type':
                    compareA = this.getEventType(a[0]['ID курса']);
                    compareB = this.getEventType(b[0]['ID курса']);
                    break;
                case 'year':
                    compareA = this.extractYearFromId(a[0]['ID курса']) || 0;
                    compareB = this.extractYearFromId(b[0]['ID курса']) || 0;
                    break;
                default:
                    compareA = 0;
                    compareB = 0;
            }
            
            if (typeof compareA === 'string' && typeof compareB === 'string') {
                return sortDirection === 'asc' 
                    ? compareA.localeCompare(compareB)
                    : compareB.localeCompare(compareA);
            } else {
                return sortDirection === 'asc' 
                    ? compareA - compareB
                    : compareB - compareA;
            }
        });
    },

    naturalSort: function(a, b, direction = 'asc') {
        const ax = [], bx = [];
        
        a.replace(/(\d+)|(\D+)/g, function(_, $1, $2) {
            ax.push([$1 || Infinity, $2 || ""]);
        });
        b.replace(/(\d+)|(\D+)/g, function(_, $1, $2) {
            bx.push([$1 || Infinity, $2 || ""]);
        });
        
        while (ax.length && bx.length) {
            const an = ax.shift();
            const bn = bx.shift();
            const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]);
            if (nn) {
                return direction === 'asc' ? nn : -nn;
            }
        }
        
        return direction === 'asc' 
            ? ax.length - bx.length 
            : bx.length - ax.length;
    },
    
    sortEvents: function(field) {
        // Если сортируем по тому же полю, меняем направление
        if (this.currentSort.field === field) {
            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.field = field;
            this.currentSort.direction = 'asc';
        }
        
        // Обновляем иконки сортировки
        document.querySelectorAll('.events-table th i').forEach(icon => {
            icon.className = 'fas fa-sort';
        });
        
        const currentHeader = document.querySelector(`.events-table th[data-sort="${field}"] i`);
        if (currentHeader) {
            currentHeader.className = this.currentSort.direction === 'asc' 
                ? 'fas fa-sort-up' 
                : 'fas fa-sort-down';
        }
        
        // Перерисовываем таблицу
        this.renderEvents();
    },
    
    getEventType: function(courseId) {
        if (!courseId) return 'Неизвестно';
        
        if (courseId.startsWith('Й')) return 'Мастер-класс';
        if (courseId.startsWith('Z')) return 'Переподготовка';
        if (courseId.startsWith('X')) return 'КПК';
        if (courseId.startsWith('М')) return 'Мероприятие';
        
        return 'Другое';
    },
    
    getCourseStatus: function(courseEvents) {
        const now = new Date();
        let hasPastDates = false;
        let hasCurrentDates = false;
        let hasFutureDates = false;
        
        courseEvents.forEach(event => {
            const eventDate = this.parseDate(event.Дата);
            if (!eventDate) return;
            
            // Считаем, что мероприятие длится один день
            const startOfDay = new Date(eventDate);
            startOfDay.setHours(0, 0, 0, 0);
            
            const endOfDay = new Date(eventDate);
            endOfDay.setHours(23, 59, 59, 999);
            
            if (now < startOfDay) {
                hasFutureDates = true;
            } else if (now > endOfDay) {
                hasPastDates = true;
            } else {
                hasCurrentDates = true;
            }
        });
        
        if (hasCurrentDates || (hasPastDates && hasFutureDates)) {
            return { text: 'Идет сейчас', class: 'active' };
        } else if (hasFutureDates && !hasPastDates && !hasCurrentDates) {
            return { text: 'Не началось', class: 'upcoming' };
        } else if (hasPastDates && !hasFutureDates && !hasCurrentDates) {
            return { text: 'Завершено', class: 'completed' };
        } else {
            return { text: 'Нет данных', class: 'unknown' };
        }
    },

    createRegistrationButton: function(courseEvents) {
        const now = new Date();
        const button = document.createElement('button');
        button.className = 'registration-button';
        
        // Анализируем даты мероприятий
        let hasPastDates = false;
        let hasCurrentDates = false;
        let hasFutureDates = false;
        
        courseEvents.forEach(event => {
            const eventDate = this.parseDate(event.Дата);
            if (!eventDate) return;
            
            // Считаем, что мероприятие длится один день
            const startOfDay = new Date(eventDate);
            startOfDay.setHours(0, 0, 0, 0);
            
            const endOfDay = new Date(eventDate);
            endOfDay.setHours(23, 59, 59, 999);
            
            if (now < startOfDay) {
                hasFutureDates = true;
            } else if (now > endOfDay) {
                hasPastDates = true;
            } else {
                hasCurrentDates = true;
            }
        });
        
        // Проверяем наличие ссылки
        const registrationLink = courseEvents[0]['Ссылка'] || '';
        
        // Определяем состояние кнопки
        if (hasCurrentDates || (hasPastDates && hasFutureDates)) {
            // Если есть текущая дата или смесь прошлых и будущих дат
            button.textContent = 'Запись завершена';
            button.disabled = true;
            button.classList.add('completed');
        } else if (hasFutureDates && !hasPastDates && !hasCurrentDates) {
            // Если все даты в будущем
            if (registrationLink) {
                button.textContent = 'Записаться';
                button.disabled = false;
                button.classList.add('active');
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.open(registrationLink, '_blank');
                });
            } else {
                button.textContent = 'Запись недоступна';
                button.disabled = true;
                button.classList.add('unavailable');
            }
        } else if (hasPastDates && !hasFutureDates && !hasCurrentDates) {
            // Если все даты в прошлом
            button.textContent = 'Запись закрыта';
            button.disabled = true;
            button.classList.add('closed');
        } else {
            // На всякий случай
            button.textContent = 'Запись недоступна';
            button.disabled = true;
            button.classList.add('unavailable');
        }
        
        return button;
    },
    
    parseDate: function(dateString) {
        if (!dateString) return null;
        const match = dateString.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
        return match ? new Date(match[3], match[2]-1, match[1]) : null;
    },
    
    showEventDetails: function(courseEvents) {
        const modal = document.getElementById('event-details-modal');
        const title = document.getElementById('modal-event-title');
        const content = document.getElementById('modal-event-content');
        
        title.textContent = courseEvents[0]['Название'] || 'Мероприятие';
        
        let html = `
            <p><strong>ID курса:</strong> ${courseEvents[0]['ID курса'] || '—'}</p>
            <p><strong>Вид мероприятия:</strong> ${this.getEventType(courseEvents[0]['ID курса'])}</p>
            <p><strong>Даты проведения:</strong> ${[...new Set(courseEvents.map(e => e.Дата))].join(', ')}</p>
            <p><strong>Статус:</strong> <span class="status-badge status-${this.getCourseStatus(courseEvents).class}">${this.getCourseStatus(courseEvents).text}</span></p>
            <p><strong>Описание:</strong> ${courseEvents[0]['Описание'] || '—'}</p>
        `;
        
        if (courseEvents[0]['Ссылка']) {
            html += `<p><strong>Ссылка для записи:</strong> <a href="${courseEvents[0]['Ссылка']}" target="_blank">${courseEvents[0]['Ссылка']}</a></p>`;
        }
        
        content.innerHTML = html;
        modal.style.display = 'block';
    },
    
    applyFilters: function() {
        const typeFilter = document.getElementById('event-type').value;
        const statusFilter = document.getElementById('event-status').value;
        const linkFilter = document.getElementById('has-link').value;
        const searchQuery = document.getElementById('search').value.toLowerCase();
        
        const rows = document.querySelectorAll('#events-table-body tr');
        
        rows.forEach(row => {
            if (row.classList.contains('summary-row')) return;
            
            const id = row.cells[0].textContent;
            const name = row.cells[2].textContent.toLowerCase();
            const type = row.cells[4].textContent;
            const status = row.cells[5].textContent;
            const hasLink = row.cells[6].querySelector('button').classList.contains('active');
            
            let showRow = true;
            
            // Применяем фильтры
            if (typeFilter !== 'all' && !id.startsWith(typeFilter)) {
                showRow = false;
            }
            
            if (statusFilter !== 'all') {
                const statusMap = {
                    'active': 'Идет сейчас',
                    'upcoming': 'Не началось',
                    'completed': 'Завершено'
                };
                
                if (status !== statusMap[statusFilter]) {
                    showRow = false;
                }
            }
            
            if (linkFilter !== 'all') {
                if ((linkFilter === 'yes' && !hasLink) || (linkFilter === 'no' && hasLink)) {
                    showRow = false;
                }
            }
            
            if (searchQuery && !name.includes(searchQuery)) {
                showRow = false;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    },
    
    resetFilters: function() {
        document.getElementById('event-type').value = 'all';
        document.getElementById('event-status').value = 'all';
        document.getElementById('has-link').value = 'all';
        document.getElementById('search').value = '';
        
        document.querySelectorAll('#events-table-body tr').forEach(row => {
            row.style.display = '';
        });
    }
};

// Функция для мобильного меню
function toggleMobileMenu() {
    const tabs = document.getElementById('main-tabs');
    if (tabs) {
        tabs.classList.toggle('mobile-visible');
    }
}

// Инициализация приложения
document.addEventListener('DOMContentLoaded', () => {
    APP.init();
});
    </script>
	<script src="statistics.js"></script>
</body>
</html>
